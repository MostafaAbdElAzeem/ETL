name: Run Python ETL

on:
  push:
    branches:
      - main

jobs:
  run-etl:
    runs-on: ubuntu-latest

    env:
      DB_HOST: localhost
      DB_PORT: 5432
      DB_NAME: mydb
      DB_USER: user
      DB_PASSWORD: password
      CSV_FILE_PATH: sales_data.csv

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          # Create user and DB matching etl.py defaults
          sudo -u postgres psql -c "CREATE USER "user" WITH PASSWORD 'password';"
          sudo -u postgres psql -c "  "    
      
      - name: Run python ETL script
        run: python etl_postgres.py
      - name: Verify data in PostgreSQL
        run: |
          sudo -u postgres psql -d mydb -c "SELECT * FROM sales;"  

